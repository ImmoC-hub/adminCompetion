<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ˆì•½ ìƒì„±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #f5f5f5 url('/static/ì¶©ë‚¨ëŒ€ ì „ê²½.jpg') center center fixed;
            background-size: cover;
            padding: 20px;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.2);
            z-index: -1;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        .card {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        input[type="text"],
        input[type="date"],
        input[type="time"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-weight: bold;
            font-size: 14px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-full {
            flex: 1;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #fcc;
        }
        .info {
            background: #e8f4f8;
            color: #555;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 13px;
            border: 1px solid #bee;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .modal h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .modal p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
    </style>
    <script>
        // ì°½ ë‹«ê¸° ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ (ëª¨ë“  ê³„ì •ì— ì ìš©)
        let isNavigating = false;
        let logoutSent = false;
        
        function performLogout() {
            if (logoutSent) return;
            logoutSent = true;
            if (navigator.sendBeacon) {
                const formData = new FormData();
                navigator.sendBeacon('/api/logout', formData);
            } else {
                try {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/api/logout', false);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.send();
                } catch (err) {}
            }
        }
        
        document.addEventListener('click', function(e) {
            const target = e.target;
            const link = target.closest('a');
            if (link && link.href) {
                const href = link.getAttribute('href');
                if (href && (href.startsWith('/') || href.startsWith(window.location.pathname))) {
                    isNavigating = true;
                } else if (href && !href.startsWith('http')) {
                    isNavigating = true;
                }
            }
        });
        document.addEventListener('submit', function(e) {
            const form = e.target;
            if (form.tagName === 'FORM') {
                isNavigating = true;
            }
        });
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                setTimeout(function() {
                    if (document.visibilityState === 'hidden' && !isNavigating) {
                        performLogout();
                    }
                }, 100);
            }
        });
        window.addEventListener('beforeunload', function(e) {
            if (!isNavigating) {
                performLogout();
            }
        });
        window.addEventListener('pagehide', function(e) {
            if (!isNavigating) {
                performLogout();
            }
        });
        window.addEventListener('unload', function(e) {
            if (!isNavigating && !logoutSent) {
                performLogout();
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ì˜ˆì•½ ìƒì„±</h1>
            
            {% if error_message %}
                <div class="error">ì˜¤ë¥˜: {{ error_message }}</div>
                {% if can_waitlist %}
                <div class="info" style="background: #fff3cd; border-color: #ffc107;">
                    <strong>ğŸ’¡ ëŒ€ê¸° ì‹ ì²­ ì•ˆë‚´</strong><br>
                    í•´ë‹¹ ì‹œê°„ëŒ€ì— ì˜ˆì•½ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ëŒ€ê¸° ì‹ ì²­ì„ í•˜ì‹œë©´ ì˜ˆì•½ì´ ì·¨ì†Œë  ë•Œ ìë™ìœ¼ë¡œ ì˜ˆì•½ì´ í• ë‹¹ë©ë‹ˆë‹¤.
                </div>
                {% endif %}
            {% endif %}
            
            <div class="info">
                <strong>ì˜ˆì•½ ê·œì¹™:</strong><br>
                â€¢ ì˜ˆì•½ì€ ì •ì‹œ~ì •ì‹œ 1ì‹œê°„ ë‹¨ìœ„ë¡œ ì—°ì† ì˜ˆì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì˜ˆ: 14:00~15:00, 14:00~17:00)<br>
                â€¢ ì˜ˆì•½ì€ ë‹¹ì¼ ìì •ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                â€¢ ê³¼ê±° ì‹œê°„ì€ ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                â€¢ ì˜ˆì•½ì€ ì˜¤ëŠ˜ë¶€í„° ìµœëŒ€ 7ì¼ í›„ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì˜¤ëŠ˜+6ì¼)<br>
                â€¢ 1ì¸ë‹¹ í™œì„±í™”ëœ ì˜ˆì•½ì€ ìµœëŒ€ 3ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                â€¢ ì˜ˆì•½í•˜ë ¤ëŠ” ì‹œê°„ ì‚¬ì´ì— ë‹¤ë¥¸ ì´ìš©ìì˜ ì˜ˆì•½ì´ ìˆìœ¼ë©´ ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                â€¢ ì°¸ì—¬ ì¸ì›ì€ ê°•ì˜ì‹¤ ìµœëŒ€ ìˆ˜ìš©ì¸ì›ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                â€¢ ì°¸ì—¬ ì¸ì›ì€ íšŒì›ì´ì–´ì•¼ í•˜ë©°, ê°ìì˜ ì˜ˆì•½ ì œí•œ(3ê°œ)ì— ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤.
            </div>
            
            <form method="POST" action="/reservations/create">
                <div class="form-group">
                    <label for="classroom_id">ê°•ì˜ì‹¤ *</label>
                    <select id="classroom_id" name="classroom_id" required>
                        <option value="">ê°•ì˜ì‹¤ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        {% for id, classroom in classrooms.items() %}
                        <option value="{{ id }}" {% if selected_classroom_id == id %}selected{% endif %}>{{ classroom.name }} ({{ classroom.location }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="date">ë‚ ì§œ *</label>
                    <input type="date" id="date" name="date" value="{% if selected_date %}{{ selected_date }}{% endif %}" required>
                </div>
                
                <div class="form-group">
                    <label for="start_time">ì‹œì‘ ì‹œê°„ *</label>
                    <select id="start_time" name="start_time" required>
                        <option value="">ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        {% for hour in range(24) %}
                        {% if hour < 10 %}
                            {% set hour_val = "0" ~ hour ~ ":00" %}
                        {% else %}
                            {% set hour_val = hour ~ ":00" %}
                        {% endif %}
                        <option value="{% if hour < 10 %}0{% endif %}{{ hour }}:00" {% if selected_start_time and selected_start_time == hour_val %}selected{% endif %}>{% if hour < 10 %}0{% endif %}{{ hour }}:00</option>
                        {% endfor %}
                    </select>
                    <small style="color: #999; display: block; margin-top: 5px;">ì •ì‹œë§Œ ì„ íƒ ê°€ëŠ¥ (ì˜ˆ: 14:00)</small>
                </div>
                
                <div class="form-group">
                    <label for="end_time">ì¢…ë£Œ ì‹œê°„ *</label>
                    <select id="end_time" name="end_time" required>
                        <option value="">ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        {% for hour in range(24) %}
                        {% if hour < 10 %}
                            {% set hour_val = "0" ~ hour ~ ":00" %}
                        {% else %}
                            {% set hour_val = hour ~ ":00" %}
                        {% endif %}
                        <option value="{% if hour < 10 %}0{% endif %}{{ hour }}:00" {% if selected_end_time and selected_end_time == hour_val %}selected{% endif %}>{% if hour < 10 %}0{% endif %}{{ hour }}:00</option>
                        {% endfor %}
                    </select>
                    <small style="color: #999; display: block; margin-top: 5px;">ì‹œì‘ ì‹œê°„ ì´í›„ì˜ ì •ì‹œ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš” (ì˜ˆ: 14:00 ì‹œì‘ ì‹œ 15:00, 16:00 ë“±)</small>
                </div>
                
                <div class="form-group">
                    <label for="participants">ì°¸ì—¬ ì¸ì› (ì„ íƒ)</label>
                    <input type="text" id="participants" name="participants" value="{% if selected_participants %}{{ selected_participants }}{% endif %}" placeholder="ì˜ˆ: user1, user2, user3">
                    <small style="color: #999; display: block; margin-top: 5px;">ì°¸ì—¬í•  ì‚¬ìš©ì IDë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”. ì°¸ì—¬ ì¸ì›ë„ íšŒì›ì´ì–´ì•¼ í•˜ë©°, ê°ìì˜ ì˜ˆì•½ ì œí•œ(3ê°œ)ì— ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤.</small>
                </div>
                
                <div class="button-group">
                    <a href="/" class="btn btn-secondary btn-full">ì·¨ì†Œ</a>
                    <button type="submit" class="btn btn-primary btn-full">ì˜ˆì•½í•˜ê¸°</button>
                    {% if can_waitlist %}
                    <button type="button" class="btn btn-warning btn-full" onclick="showWaitlistModal()">ëŒ€ê¸° ì‹ ì²­í•˜ê¸°</button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
    
    <!-- ëŒ€ê¸° ì‹ ì²­ ëª¨ë‹¬ -->
    <div id="waitlistModal" class="modal-overlay">
        <div class="modal">
            <h2>ëŒ€ê¸° ì‹ ì²­</h2>
            <p>
                ì˜ˆì•½í•˜ë ¤ëŠ” ì‹œê°„({{ waitlist_start_time }}~{{ waitlist_end_time }})ì— ë‹¤ë¥¸ ì´ìš©ìì˜ ì˜ˆì•½ì´ ì¡´ì¬í•©ë‹ˆë‹¤.<br>
                ëŒ€ê¸° ì‹ ì²­ì„ í•˜ì‹œë©´ í•´ë‹¹ ì‹œê°„ëŒ€ì˜ ì˜ˆì•½ì´ ì·¨ì†Œë  ë•Œ ìë™ìœ¼ë¡œ ì˜ˆì•½ì´ í• ë‹¹ë©ë‹ˆë‹¤.
            </p>
            <p style="margin-top: 10px; font-weight: bold; color: #333;">
                ëŒ€ê¸° ì‹ ì²­ ì‹œê°„: {{ waitlist_start_time }} ~ {{ waitlist_end_time }}
            </p>
            <p style="color: #f39c12; font-weight: bold;">
                âš ï¸ ì£¼ì˜: í˜„ì¬ í™œì„±í™”ëœ ì˜ˆì•½ì´ 3ê°œì¸ ê²½ìš° ëŒ€ê¸° ì‹ ì²­ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeWaitlistModal()">ì·¨ì†Œ</button>
                <form method="POST" action="/waitlist/create" style="display: inline;" id="waitlistForm">
                    <input type="hidden" name="classroom_id" value="{{ waitlist_classroom_id }}">
                    <input type="hidden" name="date" value="{{ waitlist_date }}">
                    <input type="hidden" name="start_time" value="{{ waitlist_start_time }}">
                    <input type="hidden" name="end_time" value="{{ waitlist_end_time }}">
                    <button type="submit" class="btn btn-warning">ëŒ€ê¸° ì‹ ì²­í•˜ê¸°</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        function showWaitlistModal() {
            document.getElementById('waitlistModal').classList.add('show');
        }
        
        function closeWaitlistModal() {
            document.getElementById('waitlistModal').classList.remove('show');
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('waitlistModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeWaitlistModal();
            }
        });
        
        {% if can_waitlist %}
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ëª¨ë‹¬ í‘œì‹œ
        window.addEventListener('load', function() {
            setTimeout(function() {
                showWaitlistModal();
            }, 300);
        });
        {% endif %}
        
        // ì˜ˆì•½ í¼ ì œì¶œ ì‹œ ì‹œê°„ ì¶©ëŒ ë°œìƒí•˜ë©´ ëŒ€ê¸° ì‹ ì²­ ëª¨ë‹¬ í‘œì‹œ
        document.querySelector('form[method="POST"][action="/reservations/create"]').addEventListener('submit', function(e) {
            // ì„œë²„ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œì¶œë§Œ í•¨
            // ì„œë²„ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ can_waitlistê°€ trueë¡œ ì„¤ì •ë˜ì–´ ëª¨ë‹¬ì´ í‘œì‹œë¨
        });
        // ì‹œì‘ ì‹œê°„ì´ ë³€ê²½ë˜ë©´ ì¢…ë£Œ ì‹œê°„ì„ ìë™ìœ¼ë¡œ ì„¤ì •
        document.getElementById('start_time').addEventListener('change', function() {
            const startTime = this.value;
            if (startTime) {
                const [hours] = startTime.split(':').map(Number);
                const endHours = (hours + 1) % 24;
                const endTime = String(endHours).padStart(2, '0') + ':00';
                document.getElementById('end_time').value = endTime;
            }
        });
        
        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •í•˜ê³  ìµœëŒ€ 7ì¼ ì œí•œ
        const today = new Date();
        const maxDate = new Date(today);
        maxDate.setDate(today.getDate() + 6); // ì˜¤ëŠ˜+6ì¼
        
        const dateInput = document.getElementById('date');
        dateInput.setAttribute('min', today.toISOString().split('T')[0]);
        dateInput.setAttribute('max', maxDate.toISOString().split('T')[0]);
    </script>
</body>
</html>

